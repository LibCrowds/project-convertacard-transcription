<style>
    #tutorial-btn {
	margin-bottom: 20px;
    }
    @media (min-width: 1200px) {
	#image-container {
	    width: calc(1170px/2);
	}
    }
    @media (min-width: 992px) and (max-width: 1199px) {
	#image-container {
	    width: calc(970px/2);
	}
    }
    @media (min-width: 768px) and (max-width: 991px) {
	#image-container {
	    width: calc(750px/2);
	}
    }
    @media (min-width: 768px) {
	#image-container {
	    position: fixed;
	    left: inherit;
	    padding-left: inherit;
	    padding-right: inherit;
	}
	#tutorial-btn {
	    float: right;
	    margin-top: 30px;
	}
    }
</style>

<!-- Image -->
<div class="row skeleton">
    <div class="col-xs-12 col-sm-6 col-sm-push-6">
	<div id="image-container">
	    <a href="#" id="photo-link"><img alt="Loading" id="photo" src="https://i.imgur.com/GeHxzb7.png"></a>
	</div>
    </div>

    <!-- Question and Answer -->
    <div class="col-xs-12 col-sm-6 col-sm-pull-6">

        <div class="row">
            <div class="col-xs-12 col-sm-8">
                <h1 id="question">What is this item?</h1>
            </div>
            <div class="col-xs-12 col-sm-4">
                <a href="../tutorial" id="tutorial-btn" class="btn btn-inverse"><span class="fa fa-book"></span> Tutorial</a>
            </div>
        </div>

	<div class="row">
	    <div class="col-xs-12">
		<form id="transcription-form" name="transcription-form" role="form">

		    <!-- Shelfmark, ISBN and language -->
		    <div class="form-step" data-step="1"  style="display:none;">
			<div class="form-group">
			    <label for="shelfmark-field">Shelfmark:</label>
			    <span rel="popover" data-content="If the resource or card has a shelfmark transcribe it exactly as given, including upper and
			    lower-case letters and any punctuation and spaces." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" data-content="Please fill in the shelfmark"
			    id="shelfmark-field" placeholder="Usually at the top-right of the card" type="text">
			</div>
			<div class="form-group">
			    <label for="isbn-field">ISBN:</label>
			    <span rel="popover" data-content="Record the ISBN if present, omitting any hyphens or spaces. If there is more than one ISBN,
			    enter the one that most accurately identifies the item." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="isbn-field" placeholder="Usually towards the bottom of the card" type="text">
			</div>

			<div class="form-group">
			    <label for="language-field">Language:</label>
			    <span rel="popover" data-content="Enter the main language of the item."
			    class="fa fa-question-circle question-popover"></span>
			    <select id="language-field" style="width: 100%">
			    </select>
			</div>

			<label class="checkbox-inline">
			    <input class="hidden-field-checkbox" data-groups='["language"]' id="series" type="checkbox">
			    This item is written in more than one language
			</label>
			<div class="form-group margin-top-sm" id="language" style="display:none;">
			    <label for="additional-language-field">Additional languages:</label>
			    <span rel="popover" data-content="Enter any additional languages of the item."
			    class="fa fa-question-circle question-popover"></span>
			    <select id="additional-language-field" multiple="multiple" style="width: 100%">
			    </select>
			</div>

			<hr>
			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-success btn-next">Next Step</a>
			</div>
		    </div>

		    <!-- Title -->
		    <div class="form-step" data-step="2" style="display:none;">
			<div class="form-group">
			    <label for="romanised-title-field">Title:</label>
			    <span rel="popover" data-content="Transcribe the title, capitalising only the first letter of the first word and any proper nouns."
			    class="fa fa-question-circle question-popover"></span>
			    <input class="form-control input-popover" data-content="Please fill in the title"
			    id="romanised-title-field" placeholder="Usually at the top of the card" type="text">
			</div>
			<div class="form-group">
			    <label for="title-field">Title (non-Roman script):</label>
			    <span rel="popover" data-content="If the title was a romanised version, give the original here."
			    class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="title-field" placeholder="Usually at the top of the card" type="text">
			</div>

			<div class="form-group">
			    <label for="romanised-subtitle-field">Subtitle:</label>
			    <span rel="popover" data-content="If there is a subtitle, transcribe it here." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="romanised-subtitle-field" placeholder="Usually at the top of the card" type="text">
			</div>
			<div class="form-group">
			    <label for="subtitle-field">Subtitle (non-Roman):</label>
			    <span rel="popover" data-content="If the subtitle was a romanised version, give the original here." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="subtitle-field" placeholder="Usually at the top of the card" type="text">
			</div>

			<hr>
			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-default btn-previous"><span class="fa fa-arrow-left"></span> Previous Step</a>
			    <a href="#" class="btn btn-success btn-next">Next Step</a>
			</div>
		    </div>

		    <!-- Author -->
		    <div class="form-step" data-step="3" style="display:none;">
			<div class="cloned-parent margin-bottom-lg">
			    <div class="cloned-input author-parent">
				<div class="form-group">
				    <label>Author:</label>
				    <input class="form-control cloned-field romanised-author-field" placeholder="Surname, First name" type="text">
				</div>
				<div class="form-group">
				    <label>Author (non-Roman script):</label>
				    <span rel="popover" data-content="If the author was a romanised version, give the original here (Surname, First name)."
					class="fa fa-question-circle question-popover"></span>
				    <input class="form-control cloned-field author-field" placeholder="Surname, First name" type="text">
				</div>
				<div class="form-group">
				    <label>Relationship to resource:</label>
				    <span rel="popover" data-content="Select the appropriate designation." class="fa fa-question-circle question-popover"></span>
				    <select class="form-control author-relationship-field">
					<option selected="" value="author">Author</option>
					<option value="addressee">Addressee</option>
					<option value="artist">Artist</option>
					<option value="cartographer">Cartographer</option>
					<option value="compiler">Compiler</option>
					<option value="composer">Composer</option>
					<option value="host_institution">Host Institution</option>
					<option value="issuing body">Issuing Body</option>
					<option value="organizer">Organizer</option>
					<option value="photographer">Photographer</option>
					<option value="sponsoring body">Sponsoring Body</option>
				    </select>
				</div>
				<div class="form-group btn-group author-type">
				    <label>Type:</label>
				    <div class="radio">
					<label><input type="radio" name="authradio" value="personal" checked="checked">Personal author</label>
				    </div>
				    <div class="radio">
					<label><input type="radio" name="authradio" value="corporate">Corporate author</label>
				    </div>
				    <div class="radio">
					<label><input type="radio" name="authradio" value="meeting">Meeting name</label>
				    </div>
				</div>
				<button class="btn btn-default clone author-btn margin-bottom-md col-xs-12" type="button"><span class="fa fa-plus"></span> Add contributor</button>
			    </div>
			</div>

			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-default btn-previous"><span class="fa fa-arrow-left"></span> Previous Step</a>
			    <a href="#" class="btn btn-success btn-next">Next Step</a>
			</div>
		    </div>

		    <!--Edition, pages, size, illustrations and series-->
		    <div class="form-step" data-step="4" style="display:none;">
			<div class="form-group">
			    <label for="edition-field">Edition:</label>
			    <span rel="popover" data-content="Transcribe any edition statement exactly as it appears." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="edition-field" placeholder="Leave blank if no edition statement provided" type="text">
			</div>
			<div class="form-group">
			    <label for="pages-field">Pages:</label>
			    <span rel="popover" data-content='Record the number of pages. If cataloguing from a card do not use abbreviations if found: use the term
			    "pages" instead of "p." or "pp.".' class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="pages-field" placeholder="Leave blank if number of pages not provided" type="text">
			</div>
			<div class="form-group">
			    <label for="illustrations-field">Illustrations:</label>
			    <span rel="popover" data-content='Record any illustrative content. Do not capitalise. If cataloguing from a card do not use abbreviations
			    if found: use the term "illustrations" instead of "ill.".' class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="illustrations-field" placeholder="Leave blank if number of illustrations  not provided" type="text">
			</div>

			<label class="checkbox-inline">
			    <input class="hidden-field-checkbox" data-groups='["series-title", "series-num"]' id="series" type="checkbox">
			    This item is part of a series
			</label>
			<div class="form-group margin-top-sm" id="series-title" style="display:none;">
			    <label for="series-title-field">Series title:</label>
			    <span rel="popover" data-content="Transcribe any series title title in romanised form, capitalising only the first letter and any proper nouns."
			    class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="series-title-field" placeholder="Enter the series to which the item belongs" type="text">
			</div>
			<div class="form-group" id="series-num" style="display:none;">
			    <label for="series-num-field">Number in series:</label>
			    <span rel="popover" data-content="Transcribe any series numbering, including any designation as given."
			    class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="series-num-field" placeholder="Enter if the number in the series is given (e.g. Volume 1)" type="text">
			</div>

			<hr>
			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-default btn-previous"><span class="fa fa-arrow-left"></span> Previous Step</a>
			    <a href="#" class="btn btn-success btn-next">Next Step</a>
			</div>
		    </div>

		    <!--Publisher, place and year of publication-->
		    <div class="form-step" data-step="5" style="display:none;">
			<div class="form-group">
			    <label for="country-field">Country of publication:</label>
			    <span rel="popover" data-content="Enter the country of publication." class="fa fa-question-circle question-popover"></span>
			    <select id="country-field" style="width: 100%">
			      <option value="" selected="selected"></option>
			    </select>
			</div>
			<div class="form-group">
			    <label for="pop-field">Place of publication:</label>
			    <span rel="popover" data-content="Transcribe the place of publication as it appears in the source. If more than one place is given, only
			    the first is required." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="pop-field" placeholder="Usually towards the bottom of the card" type="text">
			</div>
			<div class="form-group">
			    <label for="publisher-field">Publisher:</label>
			    <span rel="popover" data-content="Transcribe the publisher's name as it appears in the source. If a name is not given but can be
			    ascertained from within or outside the resource include it in square brackets." class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="publisher-field" placeholder="Usually towards the bottom of the card" type="text">
			</div>
			<div class="form-group">
			    <label for="pubyear-field">Year of publication:</label>
			    <span rel="popover" data-content='Transcribe the date as given, unless expressed as words (i.e. "1980", not "Nineteen eighty").''
			    class="fa fa-question-circle question-popover"></span>
			    <input class="form-control input-popover" id="pubyear-field" placeholder="Usually towards the bottom of the card" type="text">
			</div>
			<label class="checkbox-inline">
			    <input class="hidden-field-checkbox" data-groups='["yop-b-group"]' id="non-gregorian" type="checkbox">
			    The year above does not conform to the Gregorian calendar
			</label>
			<div class="form-group margin-top-sm" id="yop-b-group" style="display:none;">
			    <label for="norm-pubyear-field">Normalised year of publication:</label>
			    <span rel="popover" data-content='If the year of publication was given in Roman numerals or was in brackets,
			    supply a four-digit Arabic number with any uncertain digits given as "u".' class="fa fa-question-circle question-popover"></span>
			    <input class="form-control" id="norm-pubyear-field" placeholder="The Gregorian calendar year should be converted from this and still entered above" type="text">
			</div>

			<hr>
			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-default btn-previous"><span class="fa fa-arrow-left"></span> Previous Step</a>
			    <a href="#" class="btn btn-success btn-next">Next Step</a>
			</div>
		    </div>

		    <!--Subject headings-->
		    <div class="form-step" data-step="6" style="display:none;">
			<div class="form-group">
			    <label>Subject headings:</label>
			    <span rel="popover" data-content="Use the box below to search for any number of relevent subject headings." class="fa fa-question-circle question-popover"></span>
			    <div id="selected-subjects"></div>
			    <div class="input-group">
				<input class="form-control" id="subject-search-field" placeholder="Search for appropriate subject headings" type="text">
				<span class="input-group-btn">
				    <button class="btn btn-default" id="subject-search-btn" type="button">
					<span class="fa fa-search"></span>
				      <span class="fa fa-refresh fa-spin" style="display:none;"></span>
				    </button>
				</span>
			    </div>
			</div>
			<div class="pull-right"><small id="subject-search-count"></small> suggestions found</div>
			<div id="subject-search-results" class="padding-top-md"></div>
			<hr class="padding-top-sm">
			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-default btn-previous"><span class="fa fa-arrow-left"></span> Previous Step</a>
			    <a href="#" class="btn btn-success btn-next">Next Step</a>
			</div>
		    </div>

		    <!--Comments-->
		    <div class="form-step" data-step="7" style="display:none;">
			<div class="form-group">
			    <label for="comments-field">Comments:</label>
			    <span rel="popover" data-content="Use this column to enter comments for British Library staff." class="fa fa-question-circle question-popover"></span>
			    <textarea class="form-control margin-bottom-xs" rows="5" id="comments-field"
			    placeholder="Any other information that could be useful for British Library staff."></textarea>
			</div>
			<hr>
			<div class="pull-right-md" role="group">
			    <a href="#" class="btn btn-default btn-previous"><span class="fa fa-arrow-left"></span> Previous Step</a>
			    <a href="#" class="btn btn-success btn-answer" value="Done"><span class="fa fa-thumbs-o-up"></span> Done</a>
			</div>
		    </div>
		</form>
	    </div>
	</div>

        <!-- Feedback items for the user -->
        <div class="padding-top-lg text-center">
            <p id="last-edited"></p>
            <p>You are working on task: <span class="label label-default" id="task-id">#</span></p>
            <div class="progress progress-striped">
                <div class="progress-bar" id="progress" rel="tooltip" role="progressbar" style="width: 0%;" title="#"></div>
            </div>
        </div>

    </div>
</div>

<script>
    /** Select a subject heading. */
    function selectSubject(subject) {
	$('#selected-subjects').append(
	    `<div class="row subject padding-top-xs padding-bottom-xs">
	    <div class="col-xs-8 selected-subject">${subject}
	    </div><div class="col-xs-4">
	    <a class="btn btn-inverse pull-right" onclick="deselectSubject(this)">
	    <span class="fa fa-remove"></span> Remove</a></div></div>`
	);
	$('#selected-subjects').show();
    }


    /** Deselect a subject heading. */
    function deselectSubject(elem) {
	let subject = $(elem).parents('.subject')[0];
	subject.parentElement.removeChild(subject);
    }


    /** Format a subject heading suggestion. */
    function formatSuggestion(suggestion) {
	if (suggestion.type == 'alt') {
	    return suggestion.suggestall + ' - use ' + suggestion.auth;
	}
	return suggestion.auth;
    }


    /** Format a subject heading MARC string. */
    function formatMARCString(suggestion) {
	let base = suggestion.breaker || suggestion.raw || suggestion.auth;
	let tag = parseInt(suggestion.tag) + 500;
	return `${tag}  ${suggestion.indicator}7$a ${base}$2fast$0(OCoLC)${suggestion.idroot}`;
    }


    /** Clear subject headings. */
    function clearSubjects() {
	$('#selected-subjects').html('');
        $('#subject-search-results').html('');
        $('#subject-search-count').html('0');
    }


    /** Perform a subject heading search and load the results. */
    function performSearch(query) {
	let data = {
	    query: query,
	    queryIndex: 'suggestall',
	    queryReturn: 'suggestall,idroot,auth,tag,type,raw,breaker,indicator',
	    suggest: 'autoSubject'
	};
	return new Promise(function(resolve, reject) {
	    $.ajax({
		url: 'https://fast.oclc.org/searchfast/fastsuggest',
		data: data,
		dataType: 'jsonp'
	    }).done(function(data) {
		let count = data.response.numFound;
		let suggestions = data.response.docs;
		$('#subject-search-count').html(count);
		for (let suggestion of suggestions) {
		    $('#subject-search-results').append(
			`<div class="row subject"><div class="col-xs-8">${formatSuggestion(suggestion)}
			</div><div class="col-xs-4">
			<a class="btn btn-inverse pull-right" onclick="selectSubject('${formatMARCString(suggestion)}')>
			<span class="fa fa-plus"></span> Add</a></div></div><br>`
		    );
		}
		resolve();
	    }).fail(function(jqXHR, textStatus) {
		reject(new Error(textStatus));
	    });
	});
    }


    /** Handle click of subject heading search button. */
    $('#subject-search-btn').on('click', function(evt) {
	clearSubjects();
	$(this).children('.fa-spin').show();
	$(this).children('.fa-search').hide();

	let query = $('#subject-search-field').val();
	if (query.length === 0) {
	    return;
	}

	performSearch(query).catch(function(err) {
	    pybossaNotify(`Error: Subject search - ${err.message}`, 'danger');
	    throw err;
	}).then(() => {
	    $(this).children('.fa-spin').hide();
	    $(this).children('.fa-search').show();
	});
    });


    /** Key bindings. */
    $(window).keydown(function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));

	// Hit enter to search or go to the next page
	if (event.keyCode == 13) {
	    evt.preventDefault();
	    if (page == 6) {
	      $('#subject-search-btn').click();
	    } else if (page == 7) {
	       $('.btn-answer').triggerHandler('click');
	    } else {
	      changePage(page + 1);
	    }
	}
    });


    /** Override default form submission behaviour. */
    $('form').submit(function() {
	return false;
    });


    /** Handle next page button click. */
    $('.btn-next').on('click', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));
	changePage(page + 1);
    });


    /** Handle previous page button click. */
    $('.btn-previous').on('click', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));
	changePage(page - 1);
    });


    /** Change page. */
    function changePage(i) {
	$('.form-step[data-step=' + (i - 1) + ']').slideUp();
	$('.form-step[data-step=' + (i + 1) + ']').slideUp();
	$('.form-step[data-step=' + i + ']').slideDown({
	    complete: function(){
		$("input:visible, textarea:visible").first().focus();
	    }
	});
	showProgress(i, 7);
    }


    /**Show a hidden form field when associated box checked.*/
    $('.hidden-field-checkbox').on('click', function(evt) {
	$(this).data('groups').each(function(i, v) {
	    $('#' + v).slideToggle();
	});
    });


    /**Create a clone.*/
    function cloneInput() {
	let parent = $(this).parents(".cloned-parent");
	let clone = $(parent).find(".cloned-input:last").clone();

	$(clone).find('.cloned-field').each(function(i) {
	    $(this).val('');
	    $(this).siblings('.input-group-btn')
	           .children('.btn')
		   .removeClass('clone')
		   .addClass('remove-clone')
		   .children('.fa')
		   .addClass('fa-minus')
		   .removeClass('fa-plus');
	});

	$(clone).find('.author-type input').each(function() {
	    $(this).prop('name', 'authradio' + parseInt($('.author-type').length) + 1);
	});
	$(clone).appendTo(parent);
	$(clone).on('click', 'button.clone', cloneInput);
    }


    /** Handle clone button click. */
    $("button.clone").on("click", cloneInput);


    /**Remove a clone.*/
    $('button.remove-clone').on('click', function() {
	$(this).parents(".cloned-input").remove();
    });


    /**Remove all cloned fields.*/
    function removeAllClones() {
	$(".cloned-parent").each(function() {
	    $(this).find(".cloned-input:not(:first)").each(function() {
		$(this).remove();
	    });
	});
    }


    /**Show task progress.*/
    function showProgress(page, totalPages) {
	let pct = Math.round((page * 100) / totalPages);
	$("#progress").css("width", pct.toString() + "%");
	$("#progress").attr("title", pct.toString() + "% of the task completed!");
	$("#progress").tooltip({'placement': 'bottom'});
    }


    /**Load the task.*/
    pybossa.taskLoaded(function(task, deferred) {
      if (!$.isEmptyObject(task)) {
	let img = $('<img />');
	img.load(function() {
	    deferred.resolve(task);
	});
	img.attr('src', task.info.url_b + "?now=" + new Date().getTime());
	img.addClass('img-thumbnail img-responsive');
	task.info.image = img;
	} else {
	    deferred.resolve(task);
	    $("#image_container").hide();
	}
    });


    /**Load Select2 controls.*/
    function loadSelect2Controls() {
	$("#country-field").select2({
	    data: countryCodeSequence,
	    theme: "bootstrap",
	    placeholder: "Usually towards the bottom of the card",
	    allowClear: true
	});
	$("#language-field").select2({
	    data: languageCodeSequence,
	    theme: "bootstrap",
	    placeholder: "Usually towards the bottom of the card",
	    allowClear: true
	});
	$("#additional-language-field").select2({
	    data: languageCodeSequence,
	    theme: "bootstrap",
	    allowClear: true
	});
    }


    /**Present the task.*/
    pybossa.presentTask(function(task, deferred) {
	if (!$.isEmptyObject(task)) {
	    $('#photo-link').html('').append(task.info.image);
	    $("#photo-link").attr("href", task.info.link);
	    $('#task-id').html(task.id);
	    $('#transcription-form').trigger("reset");
	    $('.form-step:not(:first)').slideUp();
	    $("#last-edited").html('');
	    $("#series-title").hide();
	    $("#series-num").hide();
	    $("#yop-b-group").hide();
	    $("#shelfmark-field").focus();
	    $('.form-step:first').slideDown();
	    removeAllClones();
	    clearSubjects();
	    showProgress(1, 7);
	    loadSelect2Controls();

	    $('.btn-answer').off('click').on('click', function(evt) {
		if (typeof $(this).attr("value") != 'undefined') {
		    task.answer = {
			'shelfmark': $("#shelfmark-field").val(),
			'isbn': $("#isbn-field").val(),
			'language': $('#language-field').val(),
			'romanised_title': $("#romanised-title-field").val(),
			'title': $("#title-field").val(),
			'romanised_subtitle': $("#romanised-subtitle-field").val(),
			'subtitle': $("#subtitle-field").val(),
			'edition': $("#edition-field").val(),
			'pages': $("#pages-field").val(),
			'illustrations': $("#illustrations-field").val(),
			'place_of_publication': $("#pop-field").val(),
			'country': $("#country-field").val(),
			'publisher': $("#publisher-field").val(),
			'comments': $("#comments-field").val(),
			'series_title': $("#series-title-field").val(),
			'series_number': $("#series-num-field").val(),
			'publication_year': $("#pubyear-field").val(),
			'normalised_publication_year': $("#norm-pubyear-field").val(),
		    };

		    task.answer.multiple_languages = "";
		    if ($('#additional-language-field').val() !== null) {
			task.answer.multiple_languages = $('#additional-language-field').val().join();
		    }

		    task.answer.authors = [];
		    $('.author-parent').each(function() {
			var details = {
			    'author_romanised': $(this).find('.romanised-author-field').val(),
			    'author_original': $(this).find('.author-field').val(),
			    'relationship': $(this).find('.author-relationship-field').val(),
			    'type': $(this).find('.author-type').find('input:checked').val()
			};
			task.answer.authors.push(details);
		    });

		   task.answer.subjects  = [];
		    $('.selected-subject').each(function(i) {
			task.answer.subjects.push($(this).html());
		    });

		    pybossa.saveTask(task.id, task.answer).done(function() {
			deferred.resolve();
			pybossaNotify('Answer saved!', 'success', true);
		    }).fail(function(xhr, status, error) {
			pybossaLogError(new Error(error));
		    });
		} else {
		    pybossaNotify('Error: Answer undefined', 'danger');
		}
	    });
	} else {
	    $(".skeleton").hide();
	    pybossaNotify('Congratulations! You have participated in all available tasks!', 'success');
	}
    });

  pybossa.run('transcribe-a-card');
</script>
