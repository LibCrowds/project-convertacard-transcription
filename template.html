<style>
    #tutorial-btn {
	margin-bottom: 20px;
    }
    input[placeholder] {
	text-overflow: ellipsis;
    }
    select {
	width: 100%;
    }
    .form-step {
	display: none;
    }
    @media (min-width: 1200px) {
	#image-container {
	    width: calc(1170px/2);
	}
    }
    @media (min-width: 992px) and (max-width: 1199px) {
	#image-container {
	    width: calc(970px/2);
	}
    }
    @media (min-width: 768px) and (max-width: 991px) {
	#image-container {
	    width: calc(750px/2);
	}
    }
    @media (min-width: 768px) {
	#image-container {
	    position: fixed;
	    left: inherit;
	    padding-left: inherit;
	    padding-right: inherit;
	}
	#tutorial-btn {
	    float: right;
	    margin-top: 30px;
	}
    }
</style>

<div class="row skeleton">

    <!-- Image -->
    <div class="col-xs-12 col-sm-6 col-sm-push-6">
	<div id="image-container">
	    <a href="#" id="photo-link"><img alt="Loading" id="photo" src="https://i.imgur.com/GeHxzb7.png"></a>
	</div>
    </div>

    <!-- Question and Answer -->
    <div class="col-xs-12 col-sm-6 col-sm-pull-6">

        <div class="row">
            <div class="col-xs-12 col-sm-8">
                <h1 id="question">What is this item?</h1>
            </div>
            <div class="col-xs-12 col-sm-4">
                <a href="./tutorial" id="tutorial-btn" class="btn btn-inverse">
		    <span class="fa fa-book"></span> Tutorial
		</a>
            </div>
        </div>

	<div class="row">
	    <div class="col-xs-12">
		<form id="transcription-form" name="transcription-form" role="form">

		    <!-- Page 1 -->
		    <div class="form-step" data-step="1">
			<div class="form-group">
			    <label for="shelfmark">Shelfmark:</label>
			    <input id="shelfmark" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="isbn">ISBN:</label>
			    <input id="isbn" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="script_note">Script note:</label>
			    <input id="script_note" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="language">Language:</label>
			    <select id="language"></select>
			</div>
			<label class="checkbox-inline" data-toggle="collapse" data-target="#language-collapse">
			    <input type="checkbox"> This item is written in more than one language
			</label>
			<div id="language-collapse" class="collapse">
			    <br>
			    <div class="form-group">
				<label for="additional_languages">Additional languages:</label>
				<select id="additional_languages" multiple="multiple"></select>
			    </div>
			    <div class="form-group">
				<label for="language_note">Language note:</label>
				<input id="language_note" class="form-control" type="text">
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 2 -->
		    <div class="form-step" data-step="2">
			<div class="form-group">
			    <label for="title_romanised">Title (Romanised form):</label>
			    <input id="title_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="non_filing_romanised">Non-filing characters (Romanised form):</label>
			    <input id="non_filing_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="title_original_script">Title (original script):</label>
			    <input id="title_original_script" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="non_filing_original">Non-filing characters (original script):</label>
			    <input id="non_filing_original" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="subtitle_romanised">Subtitle (Romanised form):</label>
			    <input id="subtitle_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="subtitle_original_script">Subtitle (original script):</label>
			    <input id="subtitle_original_script" class="form-control" type="text">
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 3 -->
		    <div class="form-step" data-step="3">
			<div class="cloned-parent margin-bottom-lg">
			    <div class="cloned-input author-parent">
				<div class="form-group">
				    <label>Author:</label>
				    <input class="form-control cloned romanised-author" type="text">
				</div>
				<div class="form-group">
				    <label>Author (non-Roman script):</label>
				    <input class="form-control cloned author" type="text">
				</div>
				<div class="form-group">
				    <label>Relationship to resource:</label>
				    <select class="form-control author-relationship">
					<option selected="" value="author">Author</option>
					<option value="addressee">Addressee</option>
					<option value="artist">Artist</option>
					<option value="cartographer">Cartographer</option>
					<option value="compiler">Compiler</option>
					<option value="composer">Composer</option>
					<option value="host_institution">Host Institution</option>
					<option value="issuing body">Issuing Body</option>
					<option value="organizer">Organizer</option>
					<option value="photographer">Photographer</option>
					<option value="sponsoring body">Sponsoring Body</option>
				    </select>
				</div>
				<div class="form-group btn-group author-type">
				    <label>Type:</label>
				    <div class="radio">
					<label>
					    <input type="radio" name="authradio" value="personal">Personal author
					</label>
				    </div>
				    <div class="radio">
					<label>
					    <input type="radio" name="authradio" value="corporate">Corporate author
					</label>
				    </div>
				    <div class="radio">
					<label>
					    <input type="radio" name="authradio" value="meeting">Meeting name
					</label>
				    </div>
				</div>
				<button class="btn btn-default clone margin-bottom-md col-xs-12" type="button">
				    <span class="fa fa-plus"></span> Add contributor
				</button>
			    </div>
			</div>

			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 4 -->
		    <div class="form-step" data-step="4">
			<div class="form-group">
			    <label for="edition">Edition:</label>
			    <input id="edition" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="pages">Pages:</label>
			    <input id="pages" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="illustrations">Illustrations:</label>
			    <input id="illustrations" class="form-control" type="text">
			</div>
			<label class="checkbox-inline" data-toggle="collapse" data-target="#series-collapse">
			    <input type="checkbox"> This item is part of a series
			</label>
			<div id="series-collapse" class="collapse">
			    <br>
			    <div class="form-group">
				<label for="series_title">Series title:</label>
				<input id="series_title" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="series_number">Number in series:</label>
				<input id="series_number" class="form-control" type="text">
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 5 -->
		    <div class="form-step" data-step="5">
			<div class="form-group">
			    <label for="country">Country of publication:</label>
			    <select id="country"></select>
			</div>
			<div class="form-group">
			    <label for="place_of_publication">Place of publication:</label>
			    <input id="place_of_publication" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="publisher">Publisher:</label>
			    <input id="publisher" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="year_of_publication">Year of publication:</label>
			    <input id="year_of_publication" class="form-control" type="text">
			</div>
			<label class="checkbox-inline" data-toggle="collapse" data-target="#date-collapse">
			    <input type="checkbox"> The year above does not conform to the Gregorian calendar
			</label>
			<div id="date-collapse" class="collapse">
			    <br>
			    <div class="form-group">
				<label for="normalised_pub_year">Normalised year of publication:</label>
				<input id="normalised_pub_year" class="form-control" type="text">
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 6 -->
		    <div class="form-step" data-step="6">
			<div class="form-group">
			    <label for="subject_search">Subject headings:</label>
			    <div id="selected-subjects"></div>
			    <div class="input-group">
				<input id="subject_search" class="form-control" type="text">
				<span class="input-group-btn">
				    <button class="btn btn-default" id="subject-search-btn" type="button">
					<span class="fa fa-search"></span>
				      <span class="fa fa-refresh fa-spin" style="display:none;"></span>
				    </button>
				</span>
			    </div>
			</div>
			<div class="pull-right"><small id="subject-search-count"></small> suggestions found</div>
			<div id="subject-search-results" class="padding-top-md"></div>
			<hr class="padding-top-sm">
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 7 -->
		    <div class="form-step" data-step="7">
			<div class="form-group">
			    <label for="comments">Comments:</label>
			    <textarea id="comments" class="form-control" rows="5"></textarea>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-answer">
				<span class="fa fa-thumbs-o-up"></span> Done
			    </button>
			</div>
		    </div>
		</form>
	    </div>
	</div>

        <!-- Feedback items for the user -->
        <div class="padding-top-lg text-center">
            <p>You are working on task: <span class="label label-default" id="task-id">#</span></p>
            <div class="progress progress-striped">
                <div class="progress-bar" id="progress" rel="tooltip" role="progressbar" style="width: 0%;" title="#"></div>
            </div>
        </div>

    </div>
</div>

<script>
    /** Add tooltips and placeholders to each field. */
    function populateGuidance() {
	let guidance = {
	    shelfmark:                `If the card has a shelfmark transcribe it exactly as given, including upper and`
				      + ` lower-case letters and any punctuation and spaces.`,
	    isbn:                     `Record the ISBN if present, omitting any hyphens or spaces. If there is more`
				      + `than one ISBN, enter the one that most accurately identifies the item.`,
	    script_note:              `Add a note about the original script(s) if this would be important to the user.`,
	    language:                 `Enter the main language of the item.`,
	    additional_languages:     `If there is more than one language, enter all additional languages.`,
	    language_note:            `If the item contains text in more than one language, enter a note on the`
				      + ` languages used in the resource.`,
	    title_romanised:          `Transcribe the title, capitalising only the first letter of the first word and`
				      + ` any proper nouns.`,
	    non_filing_romanised:     `If the title begins with an initial article or symbol enter the number of`
				      + ` letters plus one for any following space`,
	    title_original_script:    `If the title was a romanised version, give the original here.`,
	    non_filing_original:      `If the title begins with an initial article or symbol enter the number of`
				      + ` letters plus one for any following space`,
	    subtitle_romanised:       `If there is a subtitle, transcribe it here.`,
	    subtitle_original_script: `If the subtitle was a romanised version, give the original here.`,
	    subject_search:           `Search for appropriate subject headings.`,
	    place_of_publication:     `Transcribe the place of publication as it appears in the source. If more than`
				      + ` one place is given, only the first is required.`,
	    publisher:                `Transcribe the publisher's name as it appears in the source. If a name is not`
	                              + ` given but can be ascertained from within or outside the resource include it`
				      + ` in square brackets.`,
	    normalised_pub_year:      `If the year of publication was given in Roman numerals or was in brackets,`
				      + ` supply a four-digit Arabic number with any uncertain digits given as`
				      + ` &quot;u&quot;. The  Gregorian calendar year should be converted from this and`
				      + ` still entered above.`,
	    year_of_publication:      `Transcribe the date as given, unless expressed as words (i.e. &quot;1980&quot;,`
				      + ` not &quot;Nineteen eighty&quot;).`
	};

	for (let key in guidance) {
	    $(`#${key}`).attr('placeholder', guidance[key].replace('\n', '').trim());
	    $(`#${key}`).before(`<span data-toggle="popover" data-content="${guidance[key]}"
				 class="fa fa-question-circle question-popover"></span>`);
	}
	$('[data-toggle="popover"]').popover({trigger: "hover"});
    }


    /** Select a subject heading. */
    function selectSubject(subject) {
	$('#selected-subjects').append(
	    `<div class="row subject padding-top-xs padding-bottom-xs">
	    <div class="col-xs-8 selected-subject">${subject}
	    </div><div class="col-xs-4">
	    <a class="btn btn-inverse pull-right" onclick="deselectSubject(this)">
	    <span class="fa fa-remove"></span> Remove</a></div></div>`
	);
	$('#selected-subjects').show();
    }


    /** Deselect a subject heading. */
    function deselectSubject(elem) {
	let subject = $(elem).parents('.subject')[0];
	subject.parentElement.removeChild(subject);
    }


    /** Format a subject heading suggestion. */
    function formatSuggestion(suggestion) {
	if (suggestion.type == 'alt') {
	    return suggestion.suggestall + ' - use ' + suggestion.auth;
	}
	return suggestion.auth;
    }


    /** Format a subject heading MARC string. */
    function formatMARCString(suggestion) {
	let base = suggestion.breaker || suggestion.raw || suggestion.auth;
	let tag = parseInt(suggestion.tag) + 500;
	return `${tag}  ${suggestion.indicator}7$a ${base}$2fast$0(OCoLC)${suggestion.idroot}`;
    }


    /** Clear subject headings. */
    function clearSubjects() {
	$('#selected-subjects').html('');
        $('#subject-search-results').html('');
        $('#subject-search-count').html('0');
    }


    /** Perform a subject heading search and load the results. */
    function performSearch(query) {
	let data = {
	    query: query,
	    queryIndex: 'suggestall',
	    queryReturn: 'suggestall,idroot,auth,tag,type,raw,breaker,indicator',
	    suggest: 'autoSubject'
	};

	return new Promise(function(resolve, reject) {
	    $.ajax({
		url: 'https://fast.oclc.org/searchfast/fastsuggest',
		data: data,
		dataType: 'jsonp'
	    }).done(function(data) {
		let count = data.response.numFound;
		let suggestions = data.response.docs;
		$('#subject-search-count').html(count);
		for (let suggestion of suggestions) {
		    $('#subject-search-results').append(
			`<div class="row subject"><div class="col-xs-8">${formatSuggestion(suggestion)}
			</div><div class="col-xs-4">
			<a class="btn btn-inverse pull-right" onclick="selectSubject('${formatMARCString(suggestion)}')">
			<span class="fa fa-plus"></span> Add</a></div></div><br>`
		    );
		}
		resolve();
	    }).fail(function(jqXHR, textStatus) {
		reject(new Error(textStatus));
	    });
	});
    }


    /** Handle click of subject heading search button. */
    $('#subject-search-btn').on('click', function(evt) {
	clearSubjects();
	$(this).children('.fa-spin').show();
	$(this).children('.fa-search').hide();
	let query = $('#subject-search').val();
	if (query.length === 0) {
	    return;
	}

	performSearch(query).catch(function(err) {
	    pybossaNotify(`Error: Subject search - ${err.message}`, 'danger');
	    throw err;
	}).then(() => {
	    $(this).children('.fa-spin').hide();
	    $(this).children('.fa-search').show();
	});
    });


    /** Key bindings. */
    $(window).keydown(function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));

	// Hit enter to go to the next page (or search subject headings)
	if (event.keyCode == 13) {
	    evt.preventDefault();
	    if (page == 6) {
	      $('#subject-search-btn').click();
	    } else if (page == 7) {
	       $('.btn-answer').triggerHandler('click');
	    } else {
	      changePage(page + 1);
	    }
	}
    });


    /** Override default form submission behaviour. */
    $('form').submit(function() {
	return false;
    });


    /** Handle next page button click. */
    $('.btn-next').on('click', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));
	changePage(page + 1);
    });


    /** Handle previous page button click. */
    $('.btn-previous').on('click', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));
	changePage(page - 1);
    });


    /** Change page. */
    function changePage(i) {
	$('.form-step[data-step=' + (i - 1) + ']').slideUp();
	$('.form-step[data-step=' + (i + 1) + ']').slideUp();
	$('.form-step[data-step=' + i + ']').slideDown({
	    complete: function(){
		$("input:visible, textarea:visible").first().focus();
	    }
	});
	showProgress(i - 1, 7);
    }


    /**Create a clone.*/
    function cloneInput() {
	let parent = $(this).parents(".cloned-parent");
	let clone = $(parent).find(".cloned-input:last").clone();

	$(clone).find('.cloned').each(function(i) {
	    $(this).val('');
	    $(this).siblings('.input-group-btn')
	           .children('.btn')
		   .removeClass('clone')
		   .addClass('remove-clone')
		   .children('.fa')
		   .addClass('fa-minus')
		   .removeClass('fa-plus');
	});

	$(clone).find('.author-type input').each(function() {
	    $(this).prop('name', 'authradio' + parseInt($('.author-type').length) + 1);
	});
	$(clone).appendTo(parent);
	$(clone).on('click', 'button.clone', cloneInput);
    }


    /** Handle clone button click. */
    $("button.clone").on("click", cloneInput);


    /**Remove a clone.*/
    $('button.remove-clone').on('click', function() {
	$(this).parents(".cloned-input").remove();
    });


    /**Remove all cloned fields.*/
    function removeAllClones() {
	$(".cloned-parent").each(function() {
	    $(this).find(".cloned-input:not(:first)").each(function() {
		$(this).remove();
	    });
	});
    }


    /**Show task progress.*/
    function showProgress(page, totalPages) {
	let pct = Math.round((page * 100) / totalPages);
	$("#progress").css("width", pct.toString() + "%");
	$("#progress").attr("title", pct.toString() + "% of the task completed!");
	$("#progress").tooltip({'placement': 'bottom'});
    }


    /**Load the task.*/
    pybossa.taskLoaded(function(task, deferred) {
      if (!$.isEmptyObject(task)) {
	let img = $('<img />');
	img.load(function() {
	    deferred.resolve(task);
	});
	img.attr('src', task.info.url_b + "?now=" + new Date().getTime());
	img.addClass('img-thumbnail img-responsive');
	task.info.image = img;
	} else {
	    deferred.resolve(task);
	    $("#image_container").hide();
	}
    });


    /**Load Select2 controls.*/
    function loadSelect2Controls() {
	$("#country").select2({
	    data: countryCodeSequence,
	    theme: "bootstrap",
	    placeholder: $("#country").attr('placeholder'),
	    allowClear: true,
	    width: '100%'
	});
	$("#language").select2({
	    data: languageCodeSequence,
	    theme: "bootstrap",
	    placeholder: $("#language").attr('placeholder'),
	    allowClear: true,
	    width: '100%'
	});
	$("#additional_languages").select2({
	    data: languageCodeSequence,
	    theme: "bootstrap",
	    placeholder: $("#additional_languages").attr('placeholder'),
	    allowClear: true,
	    width: '100%'
	});
    }


    /**Present the task.*/
    pybossa.presentTask(function(task, deferred) {
	if (!$.isEmptyObject(task)) {
	    $('#photo-link').html('').append(task.info.image);
	    $("#photo-link").attr("href", task.info.link);
	    $('#task-id').html(task.id);
	    $('#transcription-form').trigger("reset");
	    $('.form-step:not(:first)').slideUp();
	    $("#shelfmark").focus();
	    $('.form-step:first').slideDown();
	    removeAllClones();
	    clearSubjects();
	    populateGuidance();
	    showProgress(0, 7);
	    loadSelect2Controls();

	    $('.btn-answer').off('click').on('click', function(evt) {
		if (typeof $(this).attr("value") != 'undefined') {
		    task.answer = {
			'shelfmark': $("#shelfmark").val(),
			'isbn': $("#isbn").val(),
			'language': $('#language').val(),
			'language_note': $('#language_note').val(),
			'script_note': $('#script-note').val(),
			'title_romanised': $("#title_romanised").val(),
			'non_filing_romanised': $("#non_filing_romanised").val(),
			'title_original_script': $("#title_original_script").val(),
			'non_filing_original': $("#non_filing_original").val(),
			'subtitle_romanised': $("#subtitle_romanised").val(),
			'subtitle_original_script': $("#subtitle_original_script").val(),
			'edition': $("#edition").val(),
			'pages': $("#pages").val(),
			'illustrations': $("#illustrations").val(),
			'place_of_publication': $("#place_of_publication").val(),
			'country': $("#country").val(),
			'publisher': $("#publisher").val(),
			'comments': $("#comments").val(),
			'series_title': $("#series_title").val(),
			'series_number': $("#series_number").val(),
			'year_of_publication': $("#year_of_publication").val(),
			'normalised_pub_year': $("#normalised_pub_year").val(),
		    };

		    task.answer.multiple_languages = "";
		    if ($('#additional_languages').val() !== null) {
			task.answer.multiple_languages = $('#additional_languages').val().join();
		    }

		    task.answer.authors = [];
		    $('.author-parent').each(function() {
			var details = {
			    'author_romanised': $(this).find('.romanised-author').val(),
			    'author_original': $(this).find('.author').val(),
			    'relationship': $(this).find('.author-relationship').val(),
			    'type': $(this).find('.author-type').find('input:checked').val()
			};
			task.answer.authors.push(JSON.stringify(details));
		    });

		    task.answer.subjects  = [];
		    $('.selected-subject').each(function(i) {
			task.answer.subjects.push($(this).html());
		    });

		    pybossa.saveTask(task.id, task.answer).done(function() {
			deferred.resolve();
			pybossaNotify('Answer saved!', 'success', true);
		    }).fail(function(xhr, status, error) {
			pybossaLogError(new Error(error));
		    });
		} else {
		    pybossaNotify('Error: Answer undefined', 'danger');
		}
	    });
	} else {
	    $(".skeleton").hide();
	    pybossaNotify('Congratulations! You have participated in all available tasks!', 'success');
	}
    });

  pybossa.run('transcriptiontest2');
</script>
