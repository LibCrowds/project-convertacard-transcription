<style>
    #tutorial-btn {
	margin-bottom: 20px;
    }
    input[placeholder] {
	text-overflow: ellipsis;
    }
    select {
	width: 100%;
    }
    .form-step {
	display: none;
    }
    @media (min-width: 1200px) {
	#image-container {
	    width: calc(1170px/2);
	}
    }
    @media (min-width: 992px) and (max-width: 1199px) {
	#image-container {
	    width: calc(970px/2);
	}
    }
    @media (min-width: 768px) and (max-width: 991px) {
	#image-container {
	    width: calc(750px/2);
	}
    }
    @media (min-width: 768px) {
	#image-container {
	    position: fixed;
	    left: inherit;
	    padding-left: inherit;
	    padding-right: inherit;
	}
	#tutorial-btn {
	    float: right;
	    margin-top: 30px;
	}
    }
</style>

<div class="row skeleton">

    <!-- Image -->
    <div class="col-xs-12 col-sm-6 col-sm-push-6">
	<div id="image-container">
	    <a href="#" id="photo-link"><img alt="Loading" id="photo" src="https://i.imgur.com/GeHxzb7.png"></a>
	</div>
    </div>

    <!-- Question and Answer -->
    <div class="col-xs-12 col-sm-6 col-sm-pull-6">

        <div class="row">
            <div class="col-xs-12 col-sm-8">
                <h1 id="question">What is this item?</h1>
            </div>
            <div class="col-xs-12 col-sm-4">
                <a href="../tutorial" id="tutorial-btn" class="btn btn-inverse">
		    <span class="fa fa-book"></span> Tutorial
		</a>
            </div>
        </div>

	<div class="row">
	    <div class="col-xs-12">
		<form id="transcription-form" name="transcription-form" role="form">

		    <!-- Page 1 -->
		    <div class="form-step" data-step="1">
			<div class="form-group">
			    <label for="shelfmark">Shelfmark:</label>
			    <input id="shelfmark" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="isbn">ISBN:</label>
			    <input id="isbn" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="script_note">Script note:</label>
			    <input id="script_note" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="language">Language:</label>
			    <select id="language"></select>
			</div>
			<label class="checkbox-inline" data-toggle="collapse" data-target="#language-collapse">
			    <input type="checkbox"> This item is written in more than one language
			</label>
			<div id="language-collapse" class="collapse">
			    <br>
			    <div class="form-group">
				<label for="multiple_languages">Additional languages:</label>
				<select id="multiple_languages" multiple="multiple"></select>
			    </div>
			    <div class="form-group">
				<label for="language_note">Language note:</label>
				<input id="language_note" class="form-control" type="text">
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 2 -->
		    <div class="form-step" data-step="2">
			<div class="form-group">
			    <label for="title_romanised">Title (Romanised form):</label>
			    <input id="title_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="non_filing_romanised">Non-filing characters (Romanised form):</label>
			    <input id="non_filing_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="title_original">Title (original script):</label>
			    <input id="title_original" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="non_filing_original">Non-filing characters (original script):</label>
			    <input id="non_filing_original" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="state_of_res_romanised">Statement of responsibility (Romanised):</label>
			    <input id="state_of_res_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="state_of_res_original">Statement of responsibility (original script):</label>
			    <input id="state_of_res_original" class="form-control" type="text">
			</div>
			<label class="checkbox-inline" data-toggle="collapse" data-target="#title-collapse">
			    <input type="checkbox"> The item has a subtitle or a parallel title
			</label>
			<div id="title-collapse" class="collapse">
			    <br>
			    <div class="form-group">
				<label for="subtitle_romanised">Subtitle (Romanised form):</label>
				<input id="subtitle_romanised" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="subtitle_original">Subtitle (original script):</label>
				<input id="subtitle_original" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="parallel_title_romanised">Parallel title (Romanised form):</label>
				<input id="parallel_title_romanised" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="parallel_title_original">Parallel title (original script):</label>
				<input id="parallel_title_original" class="form-control" type="text">
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 3 -->
		    <div class="form-step" data-step="3">
			<div class="form-group btn-group">
			    <label for="author_type">Author Type:</label>
			    <div class="radio">
				<label>
				    <input type="radio" name="author_type" value="personal" data-toggle="collapse"
					   data-target="#personal_author_collapse">Personal
				</label>
			    </div>
			    <div class="radio">
				<label>
				    <input type="radio" name="author_type" value="corporate" data-toggle="collapse"
					   data-target="#corporate_author_collapse">Corporate
				</label>
			    </div>
			    <div class="radio">
				<label>
				    <input type="radio" name="author_type" value="meeting" data-toggle="collapse"
					   data-target="#meeting_author_collapse">Meeting
				</label>
			    </div>
			</div>
			<div id="personal_author_collapse" class="collapse">
			    <div class="form-group">
				<label for="pers_author_romanised">Personal Author (Romanised):</label>
				<select id="pers_author_romanised" class="name_authority_file"></select>
			    </div>
			    <div class="form-group">
				<label for="pers_author_fore_surname">Forename or surname:</label>
				<select id="pers_author_fore_surname" class="form-control">
				    <option selected="" value=""></option>
				    <option value="author">Forename</option>
				    <option value="Surname">Surname</option>
				</select>
			    </div>
			    <div class="form-group">
				<label for="pers_author_original">Personal Author (original script):</label>
				<input id="pers_author_original" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="pers_author_relationship">Relationship to resource:</label>
				<select id="pers_author_relationship" class="form-control">
				    <option selected="" value=""></option>
				    <option value="author">Author</option>
				    <option value="addressee">Addressee</option>
				    <option value="artist">Artist</option>
				    <option value="cartographer">Cartographer</option>
				    <option value="compiler">Compiler</option>
				    <option value="composer">Composer</option>
				    <option value="host institution">Host Institution</option>
				    <option value="issuing body">Issuing Body</option>
				    <option value="organizer">Organizer</option>
				    <option value="photographer">Photographer</option>
				    <option value="sponsoring body">Sponsoring Body</option>
				</select>
			    </div>
			</div>
			<div id="corporate_author_collapse" class="collapse">
			    <div class="form-group">
				<label for="corp_author_romanised">Corporate Author (Romanised):</label>
				<select id="corp_author_romanised" class="name_authority_file"></select>
			    </div>
			    <div class="form-group">
				<label>Corporate Author (original script):</label>
				<input id="corp_author_original" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="corp_author_jurisdiction">Jurisdiction name or direct order:</label>
				<select id="corp_author_jurisdiction" class="form-control">
				     <option selected="" value=""></option>
				    <option value="Jurisdiction">Jurisdiction</option>
				    <option value="Direct">Direct</option>
				</select>
			    </div>
			    <div class="form-group">
				<label>Relationship to resource:</label>
				<select id="corp_author_relationship" class="form-control">
				    <option selected="" value="author">Author</option>
				    <option value="addressee">Addressee</option>
				    <option value="artist">Artist</option>
				    <option value="cartographer">Cartographer</option>
				    <option value="compiler">Compiler</option>
				    <option value="composer">Composer</option>
				    <option value="host_institution">Host Institution</option>
				    <option value="issuing body">Issuing Body</option>
				    <option value="organizer">Organizer</option>
				    <option value="photographer">Photographer</option>
				    <option value="sponsoring body">Sponsoring Body</option>
				</select>
			    </div>
			</div>
			<div id="meeting_author_collapse" class="collapse">
			    <div class="form-group">
				<label for="meet_author_romanised">Meeting Name (Romanised):</label>
				<select id="meet_author_romanised" class="name_authority_file"></select>
			    </div>

			    <div class="form-group">
				<label>Meeting Name (original script):</label>
				<input id="meet_author_original" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label>Relationship to resource:</label>
				<select id="meet_author_relationship" class="form-control">
				    <option selected="" value="author">Author</option>
				    <option value="addressee">Addressee</option>
				    <option value="artist">Artist</option>
				    <option value="cartographer">Cartographer</option>
				    <option value="compiler">Compiler</option>
				    <option value="composer">Composer</option>
				    <option value="host_institution">Host Institution</option>
				    <option value="issuing body">Issuing Body</option>
				    <option value="organizer">Organizer</option>
				    <option value="photographer">Photographer</option>
				    <option value="sponsoring body">Sponsoring Body</option>
				</select>
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 4 -->
		    <div class="form-step" data-step="4">
			<div class="form-group">
			    <label for="edition_romanised">Edition (Romanised form):</label>
			    <input id="edition_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="edition_original">Edition (original script):</label>
			    <input id="edition_original" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="pages">Pages:</label>
			    <input id="pages" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="illustrations">Illustrations:</label>
			    <input id="illustrations" class="form-control" type="text">
			</div>
			<label class="checkbox-inline" data-toggle="collapse" data-target="#series-collapse">
			    <input type="checkbox"> This item is part of a series
			</label>
			<div id="series-collapse" class="collapse">
			    <br>
			    <div class="form-group">
				<label for="series_title_romanised">Series title (Romanised):</label>
				<input id="series_title_romanised" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="series_title_original">Series title (original script):</label>
				<input id="series_title_original" class="form-control" type="text">
			    </div>
			    <div class="form-group">
				<label for="number_in_series">Number in series:</label>
				<input id="number_in_series" class="form-control" type="text">
			    </div>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 5 -->
		    <div class="form-step" data-step="5">
			<div class="form-group">
			    <label for="country">Country of publication:</label>
			    <select id="country"></select>
			</div>
			<div class="form-group">
			    <label for="pub_place_romanised">Place of publication (Romanised):</label>
			    <input id="pub_place_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="pub_place_original">Place of publication (original script):</label>
			    <input id="pub_place_original" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="publisher_romanised">Publisher (Romanised):</label>
			    <input id="publisher_romanised" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="publisher_original">Publisher (original script):</label>
			    <input id="publisher_original" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="date_of_publication">Date of publication:</label>
			    <input id="date_of_publication" class="form-control" type="text">
			</div>
			<div class="form-group">
			    <label for="norm_date_of_publication">Normalised date of publication:</label>
			    <input id="norm_date_of_publication" class="form-control" type="text">
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 6 -->
		    <div class="form-step" data-step="6">
			<div class="form-group">
			    <label for="first_subject">First subject:</label>
			    <select id="first_subject" class="subject"></select>
			</div>
			<div class="form-group">
			    <label for="second_subject">Second subject:</label>
			    <select id="second_subject" class="subject"></select>
			</div>
			<div class="form-group">
			    <label for="third_subject">Third subject:</label>
			    <select id="third_subject" class="subject"></select>
			</div>
			<div class="form-group">
			    <label for="fourth_subject">Fourth subject:</label>
			    <select id="fourth_subject" class="subject"></select>
			</div>
			<div class="form-group">
			    <label for="fifth_subject">Fifth subject:</label>
			    <select id="fifth_subject" class="subject"></select>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-next">Next Step</button>
			</div>
		    </div>

		    <!-- Page 7 -->
		    <div class="form-step" data-step="7">
			<div class="form-group">
			    <label for="comments">Comments:</label>
			    <textarea id="comments" class="form-control" rows="5"></textarea>
			</div>
			<hr>
			<div class="text-right" role="group">
			    <button type="button" class="btn btn-default btn-previous">Previous Step</button>
			    <button type="button" class="btn btn-success btn-answer" value="Done">
				<span class="fa fa-thumbs-o-up"></span> Done
			    </button>
			</div>
		    </div>
		</form>
	    </div>
	</div>

        <!-- Feedback items for the user -->
        <div class="padding-top-lg text-center">
            <p>You are working on task: <span class="label label-default" id="task-id">#</span></p>
            <div class="progress progress-striped">
                <div class="progress-bar" id="progress" rel="tooltip" role="progressbar" style="width: 0%;" title="#"></div>
            </div>
        </div>

    </div>
</div>

<script>
    /** Add tooltips and placeholders to each field. */
    (function() {
	let guidance = {
	    shelfmark:                `If the card has a shelfmark transcribe it exactly as given, including upper and`
				      + ` lower-case letters and any punctuation and spaces.`,
	    isbn:                     `Record the ISBN if present, omitting any hyphens or spaces. If there is more`
				      + `than one ISBN, enter the one that most accurately identifies the item.`,
	    script_note:              `Add a note about the original script(s) if this would be important to the user.`,
	    language:                 `Enter the main language of the item.`,
	    multiple_languages:       `If there is more than one language, enter all additional languages.`,
	    language_note:            `If the item contains text in more than one language, enter a note on the`
				      + ` languages used in the resource.`,
	    title_romanised:          `Transcribe the title, capitalising only the first letter of the first word and`
				      + ` any proper nouns.`,
	    non_filing_romanised:     `If the title begins with an initial article or symbol enter the number of`
				      + ` letters plus one for any following space`,
	    title_original:           `If the title was a romanised version, give the original here.`,
	    non_filing_original:      `If the title begins with an initial article or symbol enter the number of`
				      + ` letters plus one for any following space`,
	    subtitle_romanised:       `If there is a subtitle, transcribe it here.`,
	    subtitle_original:        `If the subtitle was a romanised version, give the original here.`,
	    parallel_title_romanised: `Transcribe a parallel title here. If there is more than one, add subsequent`
				      + ` titles seperated by &quot; = &quot;`,
	    parallel_title_original:  `If the parallel title was a romanised version, give the original here`,
	    pub_place_romanised:      `Transcribe the place of publication as it appears in the source. If more than`
				      + ` one place is given, only the first is required.`,
	    pub_place_original:       `If the place of publication was a romanised version, give the original here`,
	    publisher_romanised:      `Transcribe the publisher's name as it appears in the source. If a name is not`
	                              + ` given but can be ascertained from within or outside the resource include it`
				      + ` in square brackets.`,
	    publisher_original:       `If the publisher was a romanised version, give the original here.`,
	    normalised_pub_year:      `If the year of publication was given in Roman numerals or was in brackets,`
				      + ` supply a four-digit Arabic number with any uncertain digits given as`
				      + ` &quot;u&quot;. The  Gregorian calendar year should be converted from this and`
				      + ` still entered above.`,
	    date_of_publication:      `Transcribe the date as given, unless expressed as words (i.e. &quot;1980&quot;,`
				      + ` not &quot;Nineteen eighty&quot;). Do not convert Roman numbers to Arabic.`,
	    norm_date_of_publication: `If the date of publication was given in Roman numerals or was in brackets, `
	                              + ` supply a four-digit Arabic number with any uncertain digits given as`
				      + ` &quot;u&quot;`,
	    country:                  `Enter the country of publication.`,
	    edition_romanised:        `Transcribe any edition statement exactly as it appears.`,
	    edition_original:         `If the edition was a romanised version, give the original here.`,
	    pages:                    `Record the number of pages. If cataloguing from a card do not use abbreviations`
	                              + ` if found: use the term &quot;pages&quot; instead of &quot;p.&quot; or`
				      + ` &quot;pp.&quot;.`,
	    illustrations:            `Record any illustrative content. Do not capitalise. If cataloguing from a card`
	                              + ` do not use abbreviations if found: use the term &quot;illustrations&quot;`
				      + ` instead of &quot;ill.&quot;.`,
	    series_title_romanised:   `Transcribe any series title in romanised form, capitalising only the first`
	                              + ` letter and any proper nouns.`,
	    series_title_original:    `If the series title was a romanised version, give the original here.`,
	    number_in_series:         `Transcribe any series numbering, including any designation as given.`,
	    first_subject:            `Search for an appropriate subject heading`,
	    second_subject:           `Search for an appropriate subject heading`,
	    third_subject:            `Search for an appropriate subject heading`,
	    fourth_subject:           `Search for an appropriate subject heading`,
	    fifth_subject:            `Search for an appropriate subject heading`,
	    comments:                 `Please use this column to enter comments for British Library staff.`,
	    pers_author_romanised:    `Search Library of Congress authority files for a personal author. If one can't`
				      + ` be found you can select your original search term, which will appear at the`
				      + ` top of the list followed by "(new)".`,
	    pers_author_original:     `If the personal author was a romanised version, give the original here.`,
	    pers_author_relationship: `Select the appropriate designation from the dropdown list.`,
	    pers_author_fore_surname: `Select an option from the dropdown box to indicate that either the name begins `
	                              + ` with a forename or a surname.`,
	    corp_author_romanised:    `Search Library of Congress authority files for a corporate author. If one can't`
				      + ` be found you can select your original search term, which will appear at the`
				      + ` top of the list followed by "(new)".`,
	    corp_author_original:     `If the corporate author was a romanised version, give the original here.`,
	    corp_author_jurisdiction: `Select from the dropdown box to indicate either that the name is structured as`
				      + ` a jurisdiction name (e.g. Australia. Department of Defence. Army Office) or`
				      + ` is entered in direct order (e.g. Malaysian Society of Microbiology).`,
	    corp_author_relationship: `Select the appropriate designation from the dropdown list.`,
	    meet_author_romanised:    `Search Library of Congress authority files for a meeting name. If one can't`
				      + ` be found you can select your original search term, which will appear at the`
				      + ` top of the list followed by "(new)".`,
	    meet_author_original:     `If the meeting name was a romanised version, give the original here.`,
	    meet_author_relationship: `Select the appropriate designation from the dropdown list.`,
	    state_of_res_romanised:   `Transcribe a name as given, including any text such as &quot;written by...&quot;`
				      + ` or &quot;edited by...&quot;`,
	    state_of_res_original:    `If the statement of responsibility was a romanised version, give the original`
				      + ` here`
	};

	for (let key in guidance) {
	    let text = guidance[key].replace('\n', '').trim();
	    $(`#${key}`).attr('placeholder', text);
	    $(`#${key}`).before(`<span data-toggle="popover" data-content="${text}" class="fa fa-question-circle">
				</span>`);
	}
	$('[data-toggle="popover"]').popover({trigger: "hover"});
    })();


    /**Load Select2 controls.*/
    (function() {
	$.fn.select2.defaults.set("theme", "bootstrap");
	$.fn.select2.defaults.set("allowClear", true);
	$.fn.select2.defaults.set("width", "100%");

	$.getJSON( "https://cdn.rawgit.com/LibCrowds/marc-code-lists/master/index.json", function(json) {
	    $("#country").select2({
		data: json.countries,
		placeholder: $("#country").attr('placeholder'),
	    });
	    $("#language").select2({
		data: json.languages,
		placeholder: $("#language").attr('placeholder'),
	    });
	    $("#multiple_languages").select2({
		data: json.languages,
		placeholder: $("#multiple_languages").attr('placeholder'),
	    });
	}).fail(function(jqXHR, textStatus) {
	    pybossaNotify(`Select box error: ${textStatus}`, 'danger');
	});

	// Subject data retrieved via AJAX
	$('.subject').each(function() {
	    let placeholder = $(this).attr('placeholder');
	    $(this).select2({
		placeholder: placeholder,
		ajax: {
		    url: 'https://fast.oclc.org/searchfast/fastsuggest',
		    dataType: 'jsonp',
		    cache: true,
		    data: function (params) {
			return {
			    query: params.term,
			    queryIndex: 'suggestall',
			    queryReturn: 'suggestall,idroot,auth,tag,type,raw,breaker,indicator',
			    suggest: 'autoSubject'
			};
		    },
		    processResults: function (data, params) {
			return {
			    results: $.map( data.response.docs, function (item) {
				return {
				    id: formatMARCString(item),
				    text: formatSuggestion(item),
				}
			    })
			};
		    },
		    minimumInputLength: 1,
		}
	    });
	});
    })();


    // For Z39.50 server config see https://www.loc.gov/z3950/lcserver.html
    $('.name_authority_file').each(function() {
	let placeholder = $(this).attr('placeholder');
	$(this).select2({
	    tags: true,
	    tags: true,
	createTag: function (params) {
	    return {
		id: params.term,
		text: params.term,
		newOption: true
	    }
	},
	templateResult: function (data) {
	    let result = $("<span></span>");
	    result.text(data.text);
	    if (data.newOption) {
		result.append(" <em><strong>(new)<strong></em>");
	    }
	    return result;
	},
	    placeholder: placeholder,
	    ajax: {
		url: "https://www.libcrowds.com/z3950/search/lcnaf/json",
		dataType: 'json',
		cache: true,
		data: function (params) {
		    return {
			query: '"' + params.term + '"'
		    };
		},
		processResults: function (data, params) {
		    return {
			results: $.map( data.data, function (record) {
			    let option = formatNAF(record);
			    if (option !== null) {
				return {
				    id: option,
				    text: option,
				    link: record.fields
				}
			    }
			    return null;
			})
		    };
		},
		minimumInputLength: 1,
	    }
	});
    });


    /** Format a named authority file string. */
    function formatNAF(record) {
	let option = {id: "", text: "", link: ""}
	for (let f of record.fields) {
	    if ("001" in f) {
		option.link = f.a;  // LOC control number
	    } else if ("100" in f) {
		option.id = option.text = $.map(f["100"].subfields, function(sf) {
		    return sf[Object.keys(sf)[0]];  // Personal name
		}).join(' ');
	    } else if ("110" in f) {
		option.id = option.text = $.map(f["110"].subfields, function(sf) {
		    return sf[Object.keys(sf)[0]];  // Corporate name
		}).join(' ');
	    } else if ("111" in f) {
		option.id = option.text = $.map(f["111"].subfields, function(sf) {
		    return sf[Object.keys(sf)[0]];  // Meeting name
		}).join(' ');
	    }
	}
	return option ? option.id : null;
    }


    /** Collapse previous selection when author type radio buttons clicked. */
    $('input[name=author_type]').on('click', function() {
	$('#personal_author_collapse.in').collapse('toggle');
	$('#corporate_author_collapse.in').collapse('toggle');
	$('#meeting_author_collapse.in').collapse('toggle');
    });


    /** Format a subject heading suggestion. */
    function formatSuggestion(suggestion) {
	if (suggestion.type == 'alt') {
	    return suggestion.suggestall + ' - use ' + suggestion.auth;
	}
	return suggestion.auth;
    }


    /** Format a subject heading MARC string. */
    function formatMARCString(suggestion) {
	let base = suggestion.breaker || suggestion.raw || suggestion.auth;
	let tag = parseInt(suggestion.tag) + 500;
	return `${tag}  ${suggestion.indicator}7$a ${base}$2fast$0(OCoLC)${suggestion.idroot}`;
    }


    /** Key bindings. */
    $(window).on('keydown', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));

	// Hit enter to go to the next page or submit
	if (event.keyCode == 13) {
	    evt.preventDefault();
	    if (page == 7) {
	       $('.btn-answer').triggerHandler('click');
	    } else {
	      changePage(page + 1);
	    }
	}
    });


    /** Override default form submission behaviour. */
    $('form').submit(function() {
	return false;
    });


    /** Handle next page button click. */
    $('.btn-next').on('click', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));
	changePage(page + 1);
    });


    /** Handle previous page button click. */
    $('.btn-previous').on('click', function(evt) {
	let page = parseInt($('.form-step:visible').data('step'));
	changePage(page - 1);
    });


    /** Change page. */
    function changePage(i) {
	$('.form-step[data-step=' + (i - 1) + ']').slideUp();
	$('.form-step[data-step=' + (i + 1) + ']').slideUp();
	$('.form-step[data-step=' + i + ']').slideDown({
	    complete: function(){
		$("input:visible, textarea:visible").first().focus();
	    }
	});
	showProgress(i, 7);
    }


    /**Show task progress.*/
    function showProgress(page, totalPages) {
	let pct = Math.round((page * 100) / totalPages);
	$("#progress").css("width", pct.toString() + "%");
	$("#progress").attr("title", pct.toString() + "% of the task completed!");
	$("#progress").tooltip({'placement': 'bottom'});
    }


    /**Load the task.*/
    pybossa.taskLoaded(function(task, deferred) {
	if (!$.isEmptyObject(task)) {
	    let img = $('<img />');
	    img.load(function() {
		deferred.resolve(task);
	    });
	    img.attr('src', task.info.url_b + "?now=" + new Date().getTime());
	    img.addClass('img-thumbnail img-responsive');
	    task.info.image = img;
	} else {
	    deferred.resolve(task);
	    $("#image_container").hide();
	}
    });

    /**Present the task.*/
    pybossa.presentTask(function(task, deferred) {
	if (!$.isEmptyObject(task)) {
	    $('#photo-link').html('').append(task.info.image);
	    $("#photo-link").attr("href", task.info.link);
	    $('#task-id').html(task.id);
	    $('#transcription-form').trigger("reset");
	    $('.form-step:not(:first)').slideUp();
	    $('.form-step:first').slideDown();
	    showProgress(1, 7);

	    $('.btn-answer').off('click').on('click', function(evt) {
		if (typeof $(this).attr("value") != 'undefined') {
		    task.answer = {
			shelfmark: $("#shelfmark").val(),
			isbn: $("#isbn").val(),
			language: $('#language').val(),
			language_note: $('#language_note').val(),
			script_note: $('#script_note').val(),
			title_romanised: $("#title_romanised").val(),
			non_filing_romanised: $("#non_filing_romanised").val(),
			title_original: $("#title_original").val(),
			non_filing_original: $("#non_filing_original").val(),
			subtitle_romanised: $("#subtitle_romanised").val(),
			subtitle_original: $("#subtitle_original").val(),
			parallel_title_original: $("#parallel_title_original").val(),
			parallel_title_romanised: $("#parallel_title_romanised").val(),
			edition_romanised: $("#edition_romanised").val(),
			edition_original: $("#edition_original").val(),
			pages: $("#pages").val(),
			illustrations: $("#illustrations").val(),
			pub_place_romanised: $("#pub_place_romanised").val(),
			pub_place_original: $("#pub_place_original").val(),
			country: $("#country").val(),
			publisher_romanised: $("#publisher_romanised").val(),
			publisher_original: $("#publisher_original").val(),
			comments: $("#comments").val(),
			series_title_romanised: $("#series_title_romanised").val(),
			series_title_original: $("#series_title_original").val(),
			number_in_series: $("#number_in_series").val(),
			date_of_publication: $("#date_of_publication").val(),
			norm_date_of_publication: $("#date_of_publication").val(),
			first_subject: $('#first_subject').val(),
			second_subject: $('#second_subject').val(),
			third_subject: $('#third_subject').val(),
			fourth_subject: $('#fourth_subject').val(),
			fifth_subject: $('#fifth_subject').val(),
			pers_author_romanised: $('#pers_author_romanised').val(),
			pers_author_original: $('#pers_author_original').val(),
			pers_author_relationship: $('#pers_author_relationship').val(),
			pers_author_fore_surname: $('#pers_author_fore_surname').val(),
			corp_author_romanised: $('#corp_author_romanised').val(),
			corp_author_original: $('#corp_author_original').val(),
			corp_author_jurisdiction: $('#corp_author_jurisdiction').val(),
			corp_author_relationship: $('#corp_author_relationship').val(),
			meet_author_romanised: $('#meet_author_romanised').val(),
			meet_author_original: $('#meet_author_original').val(),
			meet_author_relationship: $('#meet_author_relationship').val(),
			state_of_res_romanised: $('#state_of_res_romanised').val(),
			state_of_res_original: $('#state_of_res_original').val()
		    };

		    task.answer.multiple_languages = $('#multiple_languages').val() || "";
		    if (task.answer.multiple_languages.length) {
			task.answer.multiple_languages = $('#multiple_languages').val().join();
		    }

		    console.log(task.answer);

		    pybossa.saveTask(task.id, task.answer).done(function() {
			deferred.resolve();
			pybossaNotify('Answer saved!', 'success', true);
		    }).fail(function(xhr, status, error) {
			pybossaLogError(new Error(error));
		    });
		} else {
		    pybossaNotify('Submission error: Answer undefined', 'danger');
		}
	    });
	} else {
	    $(".skeleton").hide();
	    pybossaNotify('Congratulations! You have participated in all available tasks!', 'success');
	}
    });

    pybossa.run('transcriptiontest2');
</script>
